{"version":3,"sources":["../src/motor/Utility.js"],"names":["body","document","width","window","parseInt","getComputedStyle","getPropertyValue","height","getBodySize","epsilon","value","Math","abs","applyCSSLabel","label","animationFrame","resolve","promise","r","requestAnimationFrame","makeLowercaseSetterAliases","object","props","prop","lowercaseProp","toLowerCase","descriptor","indexOf","makeAccessorsEnumerable","set","get","enumerable","childObservationHandlers","childObserver","observeChildren","ctx","onConnect","onDisconnect","createChildObserver","observe","childList","MutationObserver","changes","weightsPerTarget","change","type","has","target","weights","addedNodes","addedNode","removedNodes","removedNode","node","weight","call","hasShadowDomV0","Element","prototype","createShadowRoot","HTMLContentElement","hasShadowDomV1","attachShadow","HTMLSlotElement","getShadowRootVersion","shadowRoot","console","log","slot","createElement","appendChild","assignedNodes","flatten","remove","length","getAncestorShadowRoot","current","ShadowRoot","parentNode","hasHtmlApi","traverse","isShadowChild","children","child","_elementManager","element","_isPossiblyDistributed","_shadowChildren","shadowChild","imperativeCounterpart"],"mappings":"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","file":"Utility.js","sourcesContent":["import windowLoaded from 'awaitbox/dom/windowLoaded'\n\nfunction epsilon(value) {\n    return Math.abs(value) < 0.000001 ? 0 : value;\n}\n\nfunction applyCSSLabel(value, label) {\n    if (value === 0) {\n        return '0px'\n    } else if (label === '%') {\n        return value * 100 + '%';\n    } else if (label === 'px') {\n        return value + 'px'\n    }\n}\n\n/**\n * Get the dimensions of the body element.\n * @async\n * @return {Object} An object containing `width` and `height` properties.\n */\nasync function getBodySize() {\n    await windowLoaded()\n\n    const body = document.body\n    const width = window.parseInt(window.getComputedStyle(body).getPropertyValue('width'))\n    const height = window.parseInt(window.getComputedStyle(body).getPropertyValue('height'))\n\n    return { width, height }\n}\n\nfunction animationFrame() {\n    let resolve = null\n    const promise = new Promise(r => resolve = r)\n    window.requestAnimationFrame(resolve)\n    return promise\n}\n\n// Create lowercase versions of each setter property.\nfunction makeLowercaseSetterAliases(object) {\n    const props = Object.getOwnPropertyNames(object)\n    for (const prop of props) {\n        const lowercaseProp = prop.toLowerCase()\n        if (lowercaseProp != prop) {\n            const descriptor = Object.getOwnPropertyDescriptor(object, prop)\n            if (Object.getOwnPropertyNames(descriptor).indexOf('set') >= 0) { // we care only about the setters.\n                Object.defineProperty(object, lowercaseProp, descriptor)\n            }\n        }\n    }\n}\n\nfunction makeAccessorsEnumerable(object) {\n    const props = Object.getOwnPropertyNames(object)\n    for (const prop of props) {\n        const descriptor = Object.getOwnPropertyDescriptor(object, prop)\n        if (descriptor && (descriptor.set || descriptor.get)) {\n            descriptor.enumerable = true\n            Object.defineProperty(object, prop, descriptor)\n        }\n    }\n}\n\n// NOTE: If a child is disconnected then connected to the same parent in the\n// same turn, then the onConnect and onDisconnect callbacks won't be called\n// because the DOM tree will be back in the exact state as before.\nlet childObservationHandlers = null\nlet childObserver = null\nfunction observeChildren(ctx, onConnect, onDisconnect) {\n    if (!childObservationHandlers) childObservationHandlers = new Map\n    if (!childObserver) childObserver = createChildObserver()\n    childObservationHandlers.set(ctx, {onConnect, onDisconnect})\n    childObserver.observe(ctx, { childList: true })\n    return true\n}\nfunction createChildObserver() {\n    return new MutationObserver(async (changes) => {\n        const weightsPerTarget = new Map\n\n        for (const change of changes) {\n            if (change.type != 'childList') continue\n\n            if (!weightsPerTarget.has(change.target))\n                weightsPerTarget.set(change.target, new Map)\n\n            const weights = weightsPerTarget.get(change.target)\n\n            for (const addedNode of change.addedNodes)\n                weights.set(addedNode, (weights.get(addedNode) || 0) + 1)\n\n            for (const removedNode of change.removedNodes)\n                weights.set(removedNode, (weights.get(removedNode) || 0) - 1)\n        }\n\n        for (const [target, weights] of weightsPerTarget) {\n            const {onConnect, onDisconnect} = childObservationHandlers.get(target)\n\n            for (const [node, weight] of weights) {\n                if (weight > 0 && typeof onConnect == 'function')\n                    onConnect.call(target, node)\n                else if (weight < 0 && typeof onDisconnect == 'function')\n                    onDisconnect.call(target, node)\n            }\n        }\n    })\n}\n\nconst hasShadowDomV0 =\n    typeof Element.prototype.createShadowRoot == 'function'\n    && typeof HTMLContentElement == 'function'\n    ? true : false\n\nconst hasShadowDomV1 =\n    typeof Element.prototype.attachShadow == 'function'\n    && typeof HTMLSlotElement == 'function'\n    ? true : false\n\nfunction getShadowRootVersion(shadowRoot) {\n    console.log('getShadowRootVersion')\n    if (!shadowRoot) return null\n    const slot = document.createElement('slot')\n    shadowRoot.appendChild(slot)\n    slot.appendChild(document.createElement('div'))\n    const assignedNodes = slot.assignedNodes({ flatten: true })\n    slot.remove()\n    console.log('hmm', assignedNodes.length, assignedNodes.length > 0 ? 'v1' : 'v0')\n    return assignedNodes.length > 0 ? 'v1' : 'v0'\n}\n\nfunction getAncestorShadowRoot(node) {\n    let current = node\n\n    while (current && !(current instanceof ShadowRoot)) {\n        current = current.parentNode\n    }\n\n    return current\n}\n\n// in the future, the user will be able to toggle the HTML API.\nconst hasHtmlApi = true\n\n// Traverses a tree while considering ShadowDOM disribution.\nfunction traverse(node, isShadowChild) {\n    console.log(isShadowChild ? 'distributedNode:' : 'node:', node)\n\n    for (const child of node.children) {\n        // skip nodes that are possiblyDistributed, i.e. they have a parent\n        // that has a ShadowRoot.\n        if (!hasHtmlApi || !child._elementManager.element._isPossiblyDistributed)\n            traverse(child)\n    }\n\n    if (hasHtmlApi && node._elementManager.element._shadowChildren) {\n        for (const shadowChild of node._elementManager.element._shadowChildren)\n            traverse(shadowChild.imperativeCounterpart, true)\n    }\n}\n\nexport {\n  epsilon,\n  applyCSSLabel,\n  getBodySize,\n  animationFrame,\n  makeLowercaseSetterAliases,\n  makeAccessorsEnumerable,\n  observeChildren,\n  getShadowRootVersion,\n  hasShadowDomV0,\n  hasShadowDomV1,\n  getAncestorShadowRoot,\n  traverse,\n}\n"]}