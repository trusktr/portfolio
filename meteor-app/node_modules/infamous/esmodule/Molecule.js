/*
 * LICENSE
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 */

import Modifier from 'famous/src/core/Modifier';
import RenderNode from 'famous/src/core/RenderNode';
import TransitionableTransform from 'famous/src/transitions/TransitionableTransform';
import EventHandler from 'famous/src/core/EventHandler';

import {simpleExtend} from './utils'

import "army-knife/polyfill.Function.name";

/**
 * Molecules are the basic building blocks of all UI components. Molecules
 * extend [famous/src/core/RenderNode](#famous/src/core/RenderNode), so they can be
 * added to any `RenderNode` of a famo.us render tree, and by default they will
 * also accept anything that a normal Famo.us `RenderNode` can accept via the
 * `add` method.  Classes that extend from `Molecule` might override
 * `RenderNode.add` in order to accept things like arrays of renderables in
 * stead of a single renderable.
 *
 * Molecules encapsulate the basic things you need for a component -- a
 * [famous/src/transitions/TransitionableTransform](#famous/src/transitions/TransitionableTransform)
 * for positioning things in space, and a [famous/src/core/EventHandler](#famous/src/core/EventHandler)
 * for capturing user interaction -- exposing a unified API for working with these
 * things. For now, [famous/src/core/Modifier](#famous/src/core/Modifier) is used as the interface
 * for applying transforms and sizing, but this will change in Mixed Mode
 * Famo.us.
 *
 * All components extend Molecule, but at the same time they can also use any
 * number of Molecules internally to do nice things like create layouts and
 * position multiple things in space.
 *
 * @class Molecule
 * @extends {module: famous/src/core/RenderNode}
 */
export class Molecule extends RenderNode {

    /**
     * Creates a new `Molecule` and applies `initialOptions` to it's internal
     * `famous/src/core/Modifier`. See [famous/src/core/Modifier](#famous/src/core/Modifier)
     * for details on what options you can pass.
     *
     * Note: Mixed Mode Famo.us does away with Modifiers, so this API will
     * change slightly, but the change will be in such a way that APIs of
     * higher level classes won't change because of this. One of the biggest
     * changes in Mixed Mode will be that `size` will be set only on a
     * per-Surface basis as far as a render tree is concerned. So if you
     * normally put multiple `Surface` instances into a `Modifier` that has a
     * size, then instead you'll have to explicitly assign a `size` to each
     * `Surface`. This is a good thing, and makes for a cleaner and easier to
     * use render tree with a separation of concerns from classes that can
     * handle boundaries and group sizing. `Molecule` might then be an example
     * of such a class with it's own size API.
     *
     * @constructor
     * @param {Object} initialOptions The options to initialize this Molecule's `Modifier` with.
     */
    constructor(initialOptions) {
        super()

        // "private" stuff. Not really, but regard it like so. For example, if
        // you see something like obj._.someVariable then you're accessing
        // internal stuff that wasn't designed to be accessed directly, and any
        // problem you enounter with that is your own problem. :)
        //
        // TODO: Use a WeakMap to store these at some point.
        this._ = {
            options: {}, // set and get with this.options
            defaultOptions: {}
        }

        // Add default values for this Molecule
        // TODO: Make default options static for the class.
        simpleExtend(this._.defaultOptions, {
            align: [0.5,0.5],
            origin: [0.5,0.5],
            transform: new TransitionableTransform,
            handler: new EventHandler
        })

        // set the user's initial options. This automatically creates
        // this.modifier, and adds it to this (don't forget, *this* is a
        // RenderNode, so a Molecule can add things to itself).
        //
        // NOTE: this.options is a setter property. This statement applies all
        // relevant properties to this.modifier.
        this.options = initialOptions;
    }

    /**
     * @property {Object} options The Molecule's options, which get applied to
     * `this.modifier`. This may change with Mixed Mode. Setting this property
     * overrides existing options. To extend existing options with new options,
     * use `setOptions` instead.  Unspecified options will be set to their default
     * values.
     *
     * Note: Anytime `this.options` is assigned a new value, `this.modifier` is set
     * to a new [famous/src/core/Modifier](#famous/src/core/Modifier).
     */
    set options(newOptions) {
        this.resetOptions();
        this.setOptions(newOptions);
    }
    get options() {
        return this._.options;
    }

    /**
     * @property {module: famous/src/transitions/TransitionableTransform} transform
     * The transform of this `Molecule`. The default is a
     * [famous/src/transitions/TransitionableTransform](#famous/src/transitions/TransitionableTransform).
     * Setting this property automatically puts the new transform into effect.
     * See [famous/src/core/Modifier.transformFrom](#famous/src/core/Modifier.transformFrom).
     */
    set transform(newTransform) {
        this.setOptions({transform: newTransform});
    }
    get transform() {
        return this.options.transform;
    }

    /**
     * Compounds `newOptions` into the existing options, similar to extending an
     * object and overriding only the desired properties. To override all
     * options with a set of new options, set `this.options` directly.
     *
     * An example of setting just a single option without erasing other options:
     *
     * ```js
     * const myMolecule = new Molecule()
     * myMolecule.setOptions({
     *   align: [0.2, 0.8]
     * })
     * ```
     *
     * @param {Object} newOptions An object containing the new options to apply to this `Molecule`.
     */
    setOptions(newOptions) {
        if (typeof newOptions == 'undefined' || newOptions.constructor.name != "Object")
            { newOptions = {} }

        for (const prop in newOptions) {
            // Subject to change when Famo.us API changes.
            if (Modifier.prototype[''+prop+'From']) {
                this.modifier[''+prop+'From'](newOptions[prop]);
            }

            this._.options[prop] = newOptions[prop];
        }
    }

    /**
     * Sets all options back to their defaults.
     *
     * Note: Anytime this is called, `this.modifier` is set to a new
     * [famous/src/core/Modifier](#famous/src/core/Modifier) having the default
     * options.
     */
    resetOptions() {
        this.modifier = new Modifier();
        this.set(this.modifier);
        this.setOptions(this._.defaultOptions);
    }

    /**
     * Forwards events from this Molecule's [famous/src/core/EventHandler](#famous/src/core/EventHandler) to the given
     * target, which can be another `EventHandler` or `Molecule`.
     *
     * This method is equivalent to [famous/src/core/EventHandler.pipe](#famous/src/core/EventHandler.pipe),
     * acting upon `this.handler`.
     *
     * TODO v0.1.0: Let this method accept a `Molecule`, then stop doing `pipe(this._.handler)` in other places
     */
    pipe() {
        const args = Array.prototype.splice.call(arguments, 0);
        return this.options.handler.pipe.apply(this.options.handler, args);
    }

    /**
     * Stops events from this Molecule's [famous/src/core/EventHandler](#famous/src/core/EventHandler)
     * from being sent to the given target.
     *
     * This method is equivalent to [famous/src/core/EventHandler.unpipe](#famous/src/core/EventHandler.unpipe),
     * acting upon `this.handler`.
     *
     * TODO v0.1.0: Let this method accept a `Molecule`, then stop doing `pipe(this.options.handler)` in other places
     */
    unpipe() {
        const args = Array.prototype.splice.call(arguments, 0);
        return this.options.handler.unpipe.apply(this.options.handler, args);
    }

    /**
     * Register an event handler for the specified event.
     * See [famous/src/core/EventHandler.on](#famous/src/core/EventHandler.on).
     */
    on() {
        const args = Array.prototype.splice.call(arguments, 0);
        return this.options.handler.on.apply(this.options.handler, args);
    }

    /**
     * Unregister an event handler for the specified event.
     * See [famous/src/core/EventHandler.off](#famous/src/core/EventHandler.off).
     */
    off() {
        const args = Array.prototype.splice.call(arguments, 0);
        return this.options.handler.on.apply(this.options.handler, args);
    }
}
export default Molecule;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9sZWN1bGUuanMiLCJzb3VyY2VzIjpbIi4uL3NyYy9Nb2xlY3VsZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTElDRU5TRVxuICpcbiAqIFRoaXMgU291cmNlIENvZGUgRm9ybSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgTW96aWxsYSBQdWJsaWNcbiAqIExpY2Vuc2UsIHYuIDIuMC4gSWYgYSBjb3B5IG9mIHRoZSBNUEwgd2FzIG5vdCBkaXN0cmlidXRlZCB3aXRoIHRoaXNcbiAqIGZpbGUsIFlvdSBjYW4gb2J0YWluIG9uZSBhdCBodHRwOi8vbW96aWxsYS5vcmcvTVBMLzIuMC8uXG4gKlxuICovXG5cbmltcG9ydCBNb2RpZmllciBmcm9tICdmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXInO1xuaW1wb3J0IFJlbmRlck5vZGUgZnJvbSAnZmFtb3VzL3NyYy9jb3JlL1JlbmRlck5vZGUnO1xuaW1wb3J0IFRyYW5zaXRpb25hYmxlVHJhbnNmb3JtIGZyb20gJ2ZhbW91cy9zcmMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGVUcmFuc2Zvcm0nO1xuaW1wb3J0IEV2ZW50SGFuZGxlciBmcm9tICdmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyJztcblxuaW1wb3J0IHtzaW1wbGVFeHRlbmR9IGZyb20gJy4vdXRpbHMnXG5cbmltcG9ydCBcImFybXkta25pZmUvcG9seWZpbGwuRnVuY3Rpb24ubmFtZVwiO1xuXG4vKipcbiAqIE1vbGVjdWxlcyBhcmUgdGhlIGJhc2ljIGJ1aWxkaW5nIGJsb2NrcyBvZiBhbGwgVUkgY29tcG9uZW50cy4gTW9sZWN1bGVzXG4gKiBleHRlbmQgW2ZhbW91cy9zcmMvY29yZS9SZW5kZXJOb2RlXSgjZmFtb3VzL3NyYy9jb3JlL1JlbmRlck5vZGUpLCBzbyB0aGV5IGNhbiBiZVxuICogYWRkZWQgdG8gYW55IGBSZW5kZXJOb2RlYCBvZiBhIGZhbW8udXMgcmVuZGVyIHRyZWUsIGFuZCBieSBkZWZhdWx0IHRoZXkgd2lsbFxuICogYWxzbyBhY2NlcHQgYW55dGhpbmcgdGhhdCBhIG5vcm1hbCBGYW1vLnVzIGBSZW5kZXJOb2RlYCBjYW4gYWNjZXB0IHZpYSB0aGVcbiAqIGBhZGRgIG1ldGhvZC4gIENsYXNzZXMgdGhhdCBleHRlbmQgZnJvbSBgTW9sZWN1bGVgIG1pZ2h0IG92ZXJyaWRlXG4gKiBgUmVuZGVyTm9kZS5hZGRgIGluIG9yZGVyIHRvIGFjY2VwdCB0aGluZ3MgbGlrZSBhcnJheXMgb2YgcmVuZGVyYWJsZXMgaW5cbiAqIHN0ZWFkIG9mIGEgc2luZ2xlIHJlbmRlcmFibGUuXG4gKlxuICogTW9sZWN1bGVzIGVuY2Fwc3VsYXRlIHRoZSBiYXNpYyB0aGluZ3MgeW91IG5lZWQgZm9yIGEgY29tcG9uZW50IC0tIGFcbiAqIFtmYW1vdXMvc3JjL3RyYW5zaXRpb25zL1RyYW5zaXRpb25hYmxlVHJhbnNmb3JtXSgjZmFtb3VzL3NyYy90cmFuc2l0aW9ucy9UcmFuc2l0aW9uYWJsZVRyYW5zZm9ybSlcbiAqIGZvciBwb3NpdGlvbmluZyB0aGluZ3MgaW4gc3BhY2UsIGFuZCBhIFtmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyXSgjZmFtb3VzL3NyYy9jb3JlL0V2ZW50SGFuZGxlcilcbiAqIGZvciBjYXB0dXJpbmcgdXNlciBpbnRlcmFjdGlvbiAtLSBleHBvc2luZyBhIHVuaWZpZWQgQVBJIGZvciB3b3JraW5nIHdpdGggdGhlc2VcbiAqIHRoaW5ncy4gRm9yIG5vdywgW2ZhbW91cy9zcmMvY29yZS9Nb2RpZmllcl0oI2ZhbW91cy9zcmMvY29yZS9Nb2RpZmllcikgaXMgdXNlZCBhcyB0aGUgaW50ZXJmYWNlXG4gKiBmb3IgYXBwbHlpbmcgdHJhbnNmb3JtcyBhbmQgc2l6aW5nLCBidXQgdGhpcyB3aWxsIGNoYW5nZSBpbiBNaXhlZCBNb2RlXG4gKiBGYW1vLnVzLlxuICpcbiAqIEFsbCBjb21wb25lbnRzIGV4dGVuZCBNb2xlY3VsZSwgYnV0IGF0IHRoZSBzYW1lIHRpbWUgdGhleSBjYW4gYWxzbyB1c2UgYW55XG4gKiBudW1iZXIgb2YgTW9sZWN1bGVzIGludGVybmFsbHkgdG8gZG8gbmljZSB0aGluZ3MgbGlrZSBjcmVhdGUgbGF5b3V0cyBhbmRcbiAqIHBvc2l0aW9uIG11bHRpcGxlIHRoaW5ncyBpbiBzcGFjZS5cbiAqXG4gKiBAY2xhc3MgTW9sZWN1bGVcbiAqIEBleHRlbmRzIHttb2R1bGU6IGZhbW91cy9zcmMvY29yZS9SZW5kZXJOb2RlfVxuICovXG5leHBvcnQgY2xhc3MgTW9sZWN1bGUgZXh0ZW5kcyBSZW5kZXJOb2RlIHtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgYE1vbGVjdWxlYCBhbmQgYXBwbGllcyBgaW5pdGlhbE9wdGlvbnNgIHRvIGl0J3MgaW50ZXJuYWxcbiAgICAgKiBgZmFtb3VzL3NyYy9jb3JlL01vZGlmaWVyYC4gU2VlIFtmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXJdKCNmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXIpXG4gICAgICogZm9yIGRldGFpbHMgb24gd2hhdCBvcHRpb25zIHlvdSBjYW4gcGFzcy5cbiAgICAgKlxuICAgICAqIE5vdGU6IE1peGVkIE1vZGUgRmFtby51cyBkb2VzIGF3YXkgd2l0aCBNb2RpZmllcnMsIHNvIHRoaXMgQVBJIHdpbGxcbiAgICAgKiBjaGFuZ2Ugc2xpZ2h0bHksIGJ1dCB0aGUgY2hhbmdlIHdpbGwgYmUgaW4gc3VjaCBhIHdheSB0aGF0IEFQSXMgb2ZcbiAgICAgKiBoaWdoZXIgbGV2ZWwgY2xhc3NlcyB3b24ndCBjaGFuZ2UgYmVjYXVzZSBvZiB0aGlzLiBPbmUgb2YgdGhlIGJpZ2dlc3RcbiAgICAgKiBjaGFuZ2VzIGluIE1peGVkIE1vZGUgd2lsbCBiZSB0aGF0IGBzaXplYCB3aWxsIGJlIHNldCBvbmx5IG9uIGFcbiAgICAgKiBwZXItU3VyZmFjZSBiYXNpcyBhcyBmYXIgYXMgYSByZW5kZXIgdHJlZSBpcyBjb25jZXJuZWQuIFNvIGlmIHlvdVxuICAgICAqIG5vcm1hbGx5IHB1dCBtdWx0aXBsZSBgU3VyZmFjZWAgaW5zdGFuY2VzIGludG8gYSBgTW9kaWZpZXJgIHRoYXQgaGFzIGFcbiAgICAgKiBzaXplLCB0aGVuIGluc3RlYWQgeW91J2xsIGhhdmUgdG8gZXhwbGljaXRseSBhc3NpZ24gYSBgc2l6ZWAgdG8gZWFjaFxuICAgICAqIGBTdXJmYWNlYC4gVGhpcyBpcyBhIGdvb2QgdGhpbmcsIGFuZCBtYWtlcyBmb3IgYSBjbGVhbmVyIGFuZCBlYXNpZXIgdG9cbiAgICAgKiB1c2UgcmVuZGVyIHRyZWUgd2l0aCBhIHNlcGFyYXRpb24gb2YgY29uY2VybnMgZnJvbSBjbGFzc2VzIHRoYXQgY2FuXG4gICAgICogaGFuZGxlIGJvdW5kYXJpZXMgYW5kIGdyb3VwIHNpemluZy4gYE1vbGVjdWxlYCBtaWdodCB0aGVuIGJlIGFuIGV4YW1wbGVcbiAgICAgKiBvZiBzdWNoIGEgY2xhc3Mgd2l0aCBpdCdzIG93biBzaXplIEFQSS5cbiAgICAgKlxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBpbml0aWFsT3B0aW9ucyBUaGUgb3B0aW9ucyB0byBpbml0aWFsaXplIHRoaXMgTW9sZWN1bGUncyBgTW9kaWZpZXJgIHdpdGguXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoaW5pdGlhbE9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIoKVxuXG4gICAgICAgIC8vIFwicHJpdmF0ZVwiIHN0dWZmLiBOb3QgcmVhbGx5LCBidXQgcmVnYXJkIGl0IGxpa2Ugc28uIEZvciBleGFtcGxlLCBpZlxuICAgICAgICAvLyB5b3Ugc2VlIHNvbWV0aGluZyBsaWtlIG9iai5fLnNvbWVWYXJpYWJsZSB0aGVuIHlvdSdyZSBhY2Nlc3NpbmdcbiAgICAgICAgLy8gaW50ZXJuYWwgc3R1ZmYgdGhhdCB3YXNuJ3QgZGVzaWduZWQgdG8gYmUgYWNjZXNzZWQgZGlyZWN0bHksIGFuZCBhbnlcbiAgICAgICAgLy8gcHJvYmxlbSB5b3UgZW5vdW50ZXIgd2l0aCB0aGF0IGlzIHlvdXIgb3duIHByb2JsZW0uIDopXG4gICAgICAgIC8vXG4gICAgICAgIC8vIFRPRE86IFVzZSBhIFdlYWtNYXAgdG8gc3RvcmUgdGhlc2UgYXQgc29tZSBwb2ludC5cbiAgICAgICAgdGhpcy5fID0ge1xuICAgICAgICAgICAgb3B0aW9uczoge30sIC8vIHNldCBhbmQgZ2V0IHdpdGggdGhpcy5vcHRpb25zXG4gICAgICAgICAgICBkZWZhdWx0T3B0aW9uczoge31cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFkZCBkZWZhdWx0IHZhbHVlcyBmb3IgdGhpcyBNb2xlY3VsZVxuICAgICAgICAvLyBUT0RPOiBNYWtlIGRlZmF1bHQgb3B0aW9ucyBzdGF0aWMgZm9yIHRoZSBjbGFzcy5cbiAgICAgICAgc2ltcGxlRXh0ZW5kKHRoaXMuXy5kZWZhdWx0T3B0aW9ucywge1xuICAgICAgICAgICAgYWxpZ246IFswLjUsMC41XSxcbiAgICAgICAgICAgIG9yaWdpbjogWzAuNSwwLjVdLFxuICAgICAgICAgICAgdHJhbnNmb3JtOiBuZXcgVHJhbnNpdGlvbmFibGVUcmFuc2Zvcm0sXG4gICAgICAgICAgICBoYW5kbGVyOiBuZXcgRXZlbnRIYW5kbGVyXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gc2V0IHRoZSB1c2VyJ3MgaW5pdGlhbCBvcHRpb25zLiBUaGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlc1xuICAgICAgICAvLyB0aGlzLm1vZGlmaWVyLCBhbmQgYWRkcyBpdCB0byB0aGlzIChkb24ndCBmb3JnZXQsICp0aGlzKiBpcyBhXG4gICAgICAgIC8vIFJlbmRlck5vZGUsIHNvIGEgTW9sZWN1bGUgY2FuIGFkZCB0aGluZ3MgdG8gaXRzZWxmKS5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gTk9URTogdGhpcy5vcHRpb25zIGlzIGEgc2V0dGVyIHByb3BlcnR5LiBUaGlzIHN0YXRlbWVudCBhcHBsaWVzIGFsbFxuICAgICAgICAvLyByZWxldmFudCBwcm9wZXJ0aWVzIHRvIHRoaXMubW9kaWZpZXIuXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IGluaXRpYWxPcHRpb25zO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBvcHRpb25zIFRoZSBNb2xlY3VsZSdzIG9wdGlvbnMsIHdoaWNoIGdldCBhcHBsaWVkIHRvXG4gICAgICogYHRoaXMubW9kaWZpZXJgLiBUaGlzIG1heSBjaGFuZ2Ugd2l0aCBNaXhlZCBNb2RlLiBTZXR0aW5nIHRoaXMgcHJvcGVydHlcbiAgICAgKiBvdmVycmlkZXMgZXhpc3Rpbmcgb3B0aW9ucy4gVG8gZXh0ZW5kIGV4aXN0aW5nIG9wdGlvbnMgd2l0aCBuZXcgb3B0aW9ucyxcbiAgICAgKiB1c2UgYHNldE9wdGlvbnNgIGluc3RlYWQuICBVbnNwZWNpZmllZCBvcHRpb25zIHdpbGwgYmUgc2V0IHRvIHRoZWlyIGRlZmF1bHRcbiAgICAgKiB2YWx1ZXMuXG4gICAgICpcbiAgICAgKiBOb3RlOiBBbnl0aW1lIGB0aGlzLm9wdGlvbnNgIGlzIGFzc2lnbmVkIGEgbmV3IHZhbHVlLCBgdGhpcy5tb2RpZmllcmAgaXMgc2V0XG4gICAgICogdG8gYSBuZXcgW2ZhbW91cy9zcmMvY29yZS9Nb2RpZmllcl0oI2ZhbW91cy9zcmMvY29yZS9Nb2RpZmllcikuXG4gICAgICovXG4gICAgc2V0IG9wdGlvbnMobmV3T3B0aW9ucykge1xuICAgICAgICB0aGlzLnJlc2V0T3B0aW9ucygpO1xuICAgICAgICB0aGlzLnNldE9wdGlvbnMobmV3T3B0aW9ucyk7XG4gICAgfVxuICAgIGdldCBvcHRpb25zKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fLm9wdGlvbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByb3BlcnR5IHttb2R1bGU6IGZhbW91cy9zcmMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGVUcmFuc2Zvcm19IHRyYW5zZm9ybVxuICAgICAqIFRoZSB0cmFuc2Zvcm0gb2YgdGhpcyBgTW9sZWN1bGVgLiBUaGUgZGVmYXVsdCBpcyBhXG4gICAgICogW2ZhbW91cy9zcmMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGVUcmFuc2Zvcm1dKCNmYW1vdXMvc3JjL3RyYW5zaXRpb25zL1RyYW5zaXRpb25hYmxlVHJhbnNmb3JtKS5cbiAgICAgKiBTZXR0aW5nIHRoaXMgcHJvcGVydHkgYXV0b21hdGljYWxseSBwdXRzIHRoZSBuZXcgdHJhbnNmb3JtIGludG8gZWZmZWN0LlxuICAgICAqIFNlZSBbZmFtb3VzL3NyYy9jb3JlL01vZGlmaWVyLnRyYW5zZm9ybUZyb21dKCNmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXIudHJhbnNmb3JtRnJvbSkuXG4gICAgICovXG4gICAgc2V0IHRyYW5zZm9ybShuZXdUcmFuc2Zvcm0pIHtcbiAgICAgICAgdGhpcy5zZXRPcHRpb25zKHt0cmFuc2Zvcm06IG5ld1RyYW5zZm9ybX0pO1xuICAgIH1cbiAgICBnZXQgdHJhbnNmb3JtKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLnRyYW5zZm9ybTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb21wb3VuZHMgYG5ld09wdGlvbnNgIGludG8gdGhlIGV4aXN0aW5nIG9wdGlvbnMsIHNpbWlsYXIgdG8gZXh0ZW5kaW5nIGFuXG4gICAgICogb2JqZWN0IGFuZCBvdmVycmlkaW5nIG9ubHkgdGhlIGRlc2lyZWQgcHJvcGVydGllcy4gVG8gb3ZlcnJpZGUgYWxsXG4gICAgICogb3B0aW9ucyB3aXRoIGEgc2V0IG9mIG5ldyBvcHRpb25zLCBzZXQgYHRoaXMub3B0aW9uc2AgZGlyZWN0bHkuXG4gICAgICpcbiAgICAgKiBBbiBleGFtcGxlIG9mIHNldHRpbmcganVzdCBhIHNpbmdsZSBvcHRpb24gd2l0aG91dCBlcmFzaW5nIG90aGVyIG9wdGlvbnM6XG4gICAgICpcbiAgICAgKiBgYGBqc1xuICAgICAqIGNvbnN0IG15TW9sZWN1bGUgPSBuZXcgTW9sZWN1bGUoKVxuICAgICAqIG15TW9sZWN1bGUuc2V0T3B0aW9ucyh7XG4gICAgICogICBhbGlnbjogWzAuMiwgMC44XVxuICAgICAqIH0pXG4gICAgICogYGBgXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gbmV3T3B0aW9ucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgbmV3IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhpcyBgTW9sZWN1bGVgLlxuICAgICAqL1xuICAgIHNldE9wdGlvbnMobmV3T3B0aW9ucykge1xuICAgICAgICBpZiAodHlwZW9mIG5ld09wdGlvbnMgPT0gJ3VuZGVmaW5lZCcgfHwgbmV3T3B0aW9ucy5jb25zdHJ1Y3Rvci5uYW1lICE9IFwiT2JqZWN0XCIpXG4gICAgICAgICAgICBuZXdPcHRpb25zID0ge31cblxuICAgICAgICBmb3IgKGNvbnN0IHByb3AgaW4gbmV3T3B0aW9ucykge1xuICAgICAgICAgICAgLy8gU3ViamVjdCB0byBjaGFuZ2Ugd2hlbiBGYW1vLnVzIEFQSSBjaGFuZ2VzLlxuICAgICAgICAgICAgaWYgKE1vZGlmaWVyLnByb3RvdHlwZVsnJytwcm9wKydGcm9tJ10pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGlmaWVyWycnK3Byb3ArJ0Zyb20nXShuZXdPcHRpb25zW3Byb3BdKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fLm9wdGlvbnNbcHJvcF0gPSBuZXdPcHRpb25zW3Byb3BdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyBhbGwgb3B0aW9ucyBiYWNrIHRvIHRoZWlyIGRlZmF1bHRzLlxuICAgICAqXG4gICAgICogTm90ZTogQW55dGltZSB0aGlzIGlzIGNhbGxlZCwgYHRoaXMubW9kaWZpZXJgIGlzIHNldCB0byBhIG5ld1xuICAgICAqIFtmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXJdKCNmYW1vdXMvc3JjL2NvcmUvTW9kaWZpZXIpIGhhdmluZyB0aGUgZGVmYXVsdFxuICAgICAqIG9wdGlvbnMuXG4gICAgICovXG4gICAgcmVzZXRPcHRpb25zKCkge1xuICAgICAgICB0aGlzLm1vZGlmaWVyID0gbmV3IE1vZGlmaWVyKCk7XG4gICAgICAgIHRoaXMuc2V0KHRoaXMubW9kaWZpZXIpO1xuICAgICAgICB0aGlzLnNldE9wdGlvbnModGhpcy5fLmRlZmF1bHRPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGb3J3YXJkcyBldmVudHMgZnJvbSB0aGlzIE1vbGVjdWxlJ3MgW2ZhbW91cy9zcmMvY29yZS9FdmVudEhhbmRsZXJdKCNmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyKSB0byB0aGUgZ2l2ZW5cbiAgICAgKiB0YXJnZXQsIHdoaWNoIGNhbiBiZSBhbm90aGVyIGBFdmVudEhhbmRsZXJgIG9yIGBNb2xlY3VsZWAuXG4gICAgICpcbiAgICAgKiBUaGlzIG1ldGhvZCBpcyBlcXVpdmFsZW50IHRvIFtmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyLnBpcGVdKCNmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyLnBpcGUpLFxuICAgICAqIGFjdGluZyB1cG9uIGB0aGlzLmhhbmRsZXJgLlxuICAgICAqXG4gICAgICogVE9ETyB2MC4xLjA6IExldCB0aGlzIG1ldGhvZCBhY2NlcHQgYSBgTW9sZWN1bGVgLCB0aGVuIHN0b3AgZG9pbmcgYHBpcGUodGhpcy5fLmhhbmRsZXIpYCBpbiBvdGhlciBwbGFjZXNcbiAgICAgKi9cbiAgICBwaXBlKCkge1xuICAgICAgICBjb25zdCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaGFuZGxlci5waXBlLmFwcGx5KHRoaXMub3B0aW9ucy5oYW5kbGVyLCBhcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wcyBldmVudHMgZnJvbSB0aGlzIE1vbGVjdWxlJ3MgW2ZhbW91cy9zcmMvY29yZS9FdmVudEhhbmRsZXJdKCNmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyKVxuICAgICAqIGZyb20gYmVpbmcgc2VudCB0byB0aGUgZ2l2ZW4gdGFyZ2V0LlxuICAgICAqXG4gICAgICogVGhpcyBtZXRob2QgaXMgZXF1aXZhbGVudCB0byBbZmFtb3VzL3NyYy9jb3JlL0V2ZW50SGFuZGxlci51bnBpcGVdKCNmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyLnVucGlwZSksXG4gICAgICogYWN0aW5nIHVwb24gYHRoaXMuaGFuZGxlcmAuXG4gICAgICpcbiAgICAgKiBUT0RPIHYwLjEuMDogTGV0IHRoaXMgbWV0aG9kIGFjY2VwdCBhIGBNb2xlY3VsZWAsIHRoZW4gc3RvcCBkb2luZyBgcGlwZSh0aGlzLm9wdGlvbnMuaGFuZGxlcilgIGluIG90aGVyIHBsYWNlc1xuICAgICAqL1xuICAgIHVucGlwZSgpIHtcbiAgICAgICAgY29uc3QgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDApO1xuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLmhhbmRsZXIudW5waXBlLmFwcGx5KHRoaXMub3B0aW9ucy5oYW5kbGVyLCBhcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50LlxuICAgICAqIFNlZSBbZmFtb3VzL3NyYy9jb3JlL0V2ZW50SGFuZGxlci5vbl0oI2ZhbW91cy9zcmMvY29yZS9FdmVudEhhbmRsZXIub24pLlxuICAgICAqL1xuICAgIG9uKCkge1xuICAgICAgICBjb25zdCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaGFuZGxlci5vbi5hcHBseSh0aGlzLm9wdGlvbnMuaGFuZGxlciwgYXJncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVW5yZWdpc3RlciBhbiBldmVudCBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIGV2ZW50LlxuICAgICAqIFNlZSBbZmFtb3VzL3NyYy9jb3JlL0V2ZW50SGFuZGxlci5vZmZdKCNmYW1vdXMvc3JjL2NvcmUvRXZlbnRIYW5kbGVyLm9mZikuXG4gICAgICovXG4gICAgb2ZmKCkge1xuICAgICAgICBjb25zdCBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaGFuZGxlci5vbi5hcHBseSh0aGlzLm9wdGlvbnMuaGFuZGxlciwgYXJncyk7XG4gICAgfVxufVxuZXhwb3J0IGRlZmF1bHQgTW9sZWN1bGU7XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7OztBQVNBLE9BQU8sUUFBUSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hELE9BQU8sVUFBVSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BELE9BQU8sdUJBQXVCLE1BQU0sZ0RBQWdELENBQUM7QUFDckYsT0FBTyxZQUFZLE1BQU0sOEJBQThCLENBQUM7O0FBRXhELFFBQVEsWUFBWSxPQUFPLFNBQVM7O0FBRXBDLE9BQU8sbUNBQW1DLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBMEIzQyxPQUFPLE1BQU0sUUFBUSxTQUFTLFVBQVUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQXNCckMsV0FBVyxDQUFDLGNBQWMsRUFBRTtRQUN4QixLQUFLLEVBQUU7Ozs7Ozs7O1FBUVAsSUFBSSxDQUFDLENBQUMsR0FBRztZQUNMLE9BQU8sRUFBRSxFQUFFO1lBQ1gsY0FBYyxFQUFFLEVBQUU7U0FDckI7Ozs7UUFJRCxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxjQUFjLEVBQUU7WUFDaEMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUNoQixNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ2pCLFNBQVMsRUFBRSxJQUFJLHVCQUF1QjtZQUN0QyxPQUFPLEVBQUUsSUFBSSxZQUFZO1NBQzVCLENBQUM7Ozs7Ozs7O1FBUUYsSUFBSSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUM7S0FDakM7Ozs7Ozs7Ozs7OztJQVlELElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRTtRQUNwQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztLQUMvQjtJQUNELElBQUksT0FBTyxHQUFHO1FBQ1YsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztLQUN6Qjs7Ozs7Ozs7O0lBU0QsSUFBSSxTQUFTLENBQUMsWUFBWSxFQUFFO1FBQ3hCLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQztLQUM5QztJQUNELElBQUksU0FBUyxHQUFHO1FBQ1osT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztLQUNqQzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBa0JELFVBQVUsQ0FBQyxVQUFVLEVBQUU7UUFDbkIsSUFBSSxPQUFPLFVBQVUsSUFBSSxXQUFXLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksUUFBUTtZQUMzRSxFQUFBLFVBQVUsR0FBRyxFQUFFLEVBQUE7O1FBRW5CLEtBQUssTUFBTSxJQUFJLElBQUksVUFBVSxFQUFFOztZQUUzQixJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDcEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ25EOztZQUVELElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMzQztLQUNKOzs7Ozs7Ozs7SUFTRCxZQUFZLEdBQUc7UUFDWCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0tBQzFDOzs7Ozs7Ozs7OztJQVdELElBQUksR0FBRztRQUNILE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3RFOzs7Ozs7Ozs7OztJQVdELE1BQU0sR0FBRztRQUNMLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3hFOzs7Ozs7SUFNRCxFQUFFLEdBQUc7UUFDRCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztLQUNwRTs7Ozs7O0lBTUQsR0FBRyxHQUFHO1FBQ0YsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2RCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDcEU7Q0FDSjtBQUNELGVBQWUsUUFBUSxDQUFDOyJ9