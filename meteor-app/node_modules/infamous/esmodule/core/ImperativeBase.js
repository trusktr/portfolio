import ElementManager from './ElementManager'
import Sizeable from './Sizeable'
import Node from './Node'
import Scene from './Scene'
import Motor from './Motor'
import {isInstanceof} from './Utility'

// We explicitly use `var` instead of `let` here because it is hoisted for the
// Node and Scene modules. This, along with the following initImperativeBase
// function, allows the circular dependency between this module and the Node and
// Scene modules to work. For details on why, see
// https://esdiscuss.org/topic/how-to-solve-this-basic-es6-module-circular-dependency-problem.
var ImperativeBase

// Here we wrap the definition of the ImperativeBase class with this function in
// order to solve the circular depdendency problem caused by the
// Node<->ImperativeBase and Scene<->ImperativeBase circles. The Node and Scene
// modules call initImperativeBase to ensure that the ImperativeBase declaration
// happens first, and then those modules can use the live binding in their
// declarations.
initImperativeBase()
export function initImperativeBase() {
    if (ImperativeBase) { return }

    const instanceofSymbol = Symbol('instanceofSymbol')

    /**
     * The ImperativeBase class is the base class for the Imperative version of the
     * API, for people who chose to take the all-JavaScript approach and who will
     * not use the HTML-based API (infamous/motor-html).
     *
     * In the future when there is an option to disable the HTML-DOM rendering (and
     * render only WebGL, for example) then the imperative API will be the only API
     * available since the HTML API will be turned off as a result of disabling
     * HTML rendering. Disabling both WebGL and HTML won't make sense, as we'll need
     * at least one of those to render with.
     */
    const ImperativeBaseMixin = function (base) {
        const ParentClass = base
        var ImperativeBase = (function (ParentClass) {
            function ImperativeBase(options) {
                var this$1 = this;
                if ( options === void 0 ) options = {};


                // The presence of a _motorHtmlCounterpart argument signifies that
                // the HTML interface is being used, otherwise the imperative interface
                // here is being used. For example, see MotorHTMLNode. This means the
                // Node and MotorHTMLNode classes are coupled together, but it's in the
                // name of the API that we're supporting.
                var _motorHtmlCounterpart = options._motorHtmlCounterpart;

                ParentClass.call(this, options)

                this._willBeRendered = false

                // Here we create the DOM HTMLElement associated with this
                // Imperative-API Node.
                this._elementManager = new ElementManager(
                    _motorHtmlCounterpart || this._makeElement()
                )
                this._elementManager.element._associateImperativeNode(this)

                // For Nodes, true when this Node is added to a parent AND it
                // has an anancestor Scene that is mounted into DOM. For
                // Scenes, true when mounted into DOM.
                this._mounted = false;

                // For Nodes, a promise that resolves when this Node is
                // attached to a tree that has a root Scene TreeNode *and* when
                // that root Scene has been mounted into the DOM. For Scenes,
                // resolves when mounted into DOM.
                this._mountPromise = null
                this._resolveMountPromise = null
                this._rejectMountPromise = null

                this._awaitingMountPromiseToRender = false
                this._waitingForMountConditions = false

                // See Transformable/Sizeable propertychange event.
                this.on('propertychange', function (prop) {
                    if (
                        prop == 'sizeMode' ||
                        prop == 'absoluteSize' ||
                        prop == 'proportionalSize'
                    ) {
                        this$1._calcSize()
                    }

                    this$1._needsToBeRendered()
                })
            }

            if ( ParentClass ) ImperativeBase.__proto__ = ParentClass;
            ImperativeBase.prototype = Object.create( ParentClass && ParentClass.prototype );
            ImperativeBase.prototype.constructor = ImperativeBase;

            var prototypeAccessors = { mountPromise: {},element: {} };

            /**
             * Subclasses are required to override this. It should return the HTML-API
             * counterpart for this Imperative-API instance. See Node or Scene classes
             * for example.
             *
             * @private
             */
            ImperativeBase.prototype._makeElement = function _makeElement () {
                throw new Error('Subclasses need to override ImperativeBase#_makeElement.')
            };

            /**
             * @readonly
             */
            prototypeAccessors.mountPromise.get = function () {
                var this$1 = this;

                if (!this._mountPromise) {
                    this._mountPromise = new Promise(function (resolve, reject) {
                        this$1._resolveMountPromise = resolve
                        this$1._rejectMountPromise = reject
                    })
                }

                if (!this._mounted)
                    { this._waitForMountThenResolveMountPromise() }
                else if (this._mounted)
                    { this._resolveMountPromise() }

                return this._mountPromise
            };

            ImperativeBase.prototype._waitForMountThenResolveMountPromise = function _waitForMountThenResolveMountPromise () {
                // extended in Node or Scene to await for anything that mount
                // depends on.
            };

            /**
             * @readonly
             */
            prototypeAccessors.element.get = function () {
                return this._elementManager.element
            };

            /**
             * @override
             */
            ImperativeBase.prototype.addChild = function addChild (childNode) {
                if (!isInstanceof(childNode, ImperativeBase)) { return }

                // We cannot add Scenes to Nodes, for now.
                if (childNode instanceof Scene) {
                    throw new Error("\n                        A Scene cannot be added to another Node or Scene (at\n                        least for now). To place a Scene in a Node, just mount\n                        a new Scene onto a MotorHTMLNode with Scene.mount().\n                    ")
                }

                ParentClass.prototype.addChild.call(this, childNode)

                // Pass this parent node's Scene reference (if any, checking this cache
                // first) to the new child and the child's children.
                if (childNode._scene || childNode.scene) {
                    if (childNode._resolveScenePromise)
                        { childNode._resolveScenePromise(childNode._scene) }
                    childNode._giveSceneRefToChildren()
                }

                // Calculate sizing because proportional size might depend on
                // the new parent.
                childNode._calcSize()
                childNode._needsToBeRendered()

                // child should watch the parent for size changes.
                this.on('sizechange', childNode._onParentSizeChange)

                this._elementManager.connectChildElement(childNode)

                return this
            };

            ImperativeBase.prototype.removeChild = function removeChild (childNode, /*private use*/leaveInDom) {
                if (!(childNode instanceof Node)) { return }

                ParentClass.prototype.removeChild.call(this, childNode)

                this.off('sizechange', childNode._onParentSizeChange)

                childNode._resetSceneRef()

                if (childNode._mountPromise) { childNode._rejectMountPromise('mountcancel') }
                if (childNode._mounted) { childNode._elementManager.shouldNotRender() }
                childNode._resetMountPromise()

                if (!leaveInDom)
                    { this._elementManager.disconnectChildElement(childNode) }
            };

            ImperativeBase.prototype._resetMountPromise = function _resetMountPromise () {
                this._mounted = false
                this._mountPromise = null
                this._resolveMountPromise = null
                this._rejectMountPromise = null
                const children = this._children
                for (let i=0, l=children.length; i<l; i+=1) {
                    children[i]._resetMountPromise();
                }
            };

            ImperativeBase.prototype._needsToBeRendered = function _needsToBeRendered () {
                var this$1 = this;

                if (this._awaitingMountPromiseToRender) { return Promise.resolve() }

                const logic = function () {
                    this$1._willBeRendered = true
                    Motor._setNodeToBeRendered(this$1)
                }

                if (!this._mounted) {
                    this._awaitingMountPromiseToRender = true

                    let possibleError = undefined

                    // try
                    return this.mountPromise

                    .then(logic)

                    // catch
                    .catch(function () {
                        if (e == 'mountcancel') { return }
                        else { possibleError = e }
                    })

                    // finally
                    .then(function () {
                        this$1._awaitingMountPromiseToRender = false

                        if (possibleError) { throw possibleError }
                    })
                }

                logic()
                return Promise.resolve()
            };
            //async _needsToBeRendered() {
                //if (this._awaitingMountPromiseToRender) return

                //if (!this._mounted) {
                    //try {
                        //this._awaitingMountPromiseToRender = true
                        //await this.mountPromise
                    //} catch(e) {
                        //if (e == 'mountcancel') return
                        //else throw e
                    //} finally {
                        //this._awaitingMountPromiseToRender = false
                    //}
                //}

                //this._willBeRendered = true
                //Motor._setNodeToBeRendered(this)
            //}

            // This method is used by Motor._renderNodes().
            ImperativeBase.prototype._getAncestorToBeRendered = function _getAncestorToBeRendered () {
                let parent = this._parent

                while (parent) {
                    if (parent._willBeRendered) { return parent }
                    parent = parent._parent
                }

                return false
            };

            ImperativeBase.prototype._render = function _render (timestamp) {
                ParentClass.prototype._render.call(this)
                // applies the transform matrix to the element's style property.
                this._elementManager.applyImperativeNodeProperties(this)
            };

            Object.defineProperties( ImperativeBase.prototype, prototypeAccessors );

            return ImperativeBase;
        }(ParentClass));

        var ref = Object.getOwnPropertyDescriptor(ParentClass.prototype, 'properties');
        var superPropertiesSet = ref.set;

        Object.defineProperties(ImperativeBase.prototype, {

            /**
             * Set all properties of an ImperativeBase instance in one method.
             *
             * @param {Object} properties Properties object - see example.
             *
             * @example
             * node.properties = {
             *   classes: ['open', 'big'],
             * }
             */
            properties: {
                set: function set(properties) {
                    if ( properties === void 0 ) properties = {};

                    superPropertiesSet.call(this, properties)

                    if (properties.classes)
                        { (ref = this._elementManager).setClasses.apply(ref, properties.classes);
                    var ref; }
                },
                configurable: true,
            },
        })

        Object.defineProperty(ImperativeBase, Symbol.hasInstance, {
            value: function(obj) {
                if (this !== ImperativeBase) { return Object.getPrototypeOf(ImperativeBase)[Symbol.hasInstance].call(this, obj) }

                let currentProto = obj

                while(currentProto) {
                    const desc = Object.getOwnPropertyDescriptor(currentProto, "constructor")

                    if (desc && desc.value && desc.value.hasOwnProperty(instanceofSymbol))
                        { return true }

                    currentProto = Object.getPrototypeOf(currentProto)
                }

                return false
            }
        })

        ImperativeBase[instanceofSymbol] = true

        return ImperativeBase
    }

    ImperativeBase = ImperativeBaseMixin(Sizeable)
    ImperativeBase.mixin = ImperativeBaseMixin

}

export {ImperativeBase as default}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW1wZXJhdGl2ZUJhc2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL0ltcGVyYXRpdmVCYXNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFbGVtZW50TWFuYWdlciBmcm9tICcuL0VsZW1lbnRNYW5hZ2VyJ1xuaW1wb3J0IFNpemVhYmxlIGZyb20gJy4vU2l6ZWFibGUnXG5pbXBvcnQgTm9kZSBmcm9tICcuL05vZGUnXG5pbXBvcnQgU2NlbmUgZnJvbSAnLi9TY2VuZSdcbmltcG9ydCBNb3RvciBmcm9tICcuL01vdG9yJ1xuaW1wb3J0IHtpc0luc3RhbmNlb2Z9IGZyb20gJy4vVXRpbGl0eSdcblxuLy8gV2UgZXhwbGljaXRseSB1c2UgYHZhcmAgaW5zdGVhZCBvZiBgbGV0YCBoZXJlIGJlY2F1c2UgaXQgaXMgaG9pc3RlZCBmb3IgdGhlXG4vLyBOb2RlIGFuZCBTY2VuZSBtb2R1bGVzLiBUaGlzLCBhbG9uZyB3aXRoIHRoZSBmb2xsb3dpbmcgaW5pdEltcGVyYXRpdmVCYXNlXG4vLyBmdW5jdGlvbiwgYWxsb3dzIHRoZSBjaXJjdWxhciBkZXBlbmRlbmN5IGJldHdlZW4gdGhpcyBtb2R1bGUgYW5kIHRoZSBOb2RlIGFuZFxuLy8gU2NlbmUgbW9kdWxlcyB0byB3b3JrLiBGb3IgZGV0YWlscyBvbiB3aHksIHNlZVxuLy8gaHR0cHM6Ly9lc2Rpc2N1c3Mub3JnL3RvcGljL2hvdy10by1zb2x2ZS10aGlzLWJhc2ljLWVzNi1tb2R1bGUtY2lyY3VsYXItZGVwZW5kZW5jeS1wcm9ibGVtLlxudmFyIEltcGVyYXRpdmVCYXNlXG5cbi8vIEhlcmUgd2Ugd3JhcCB0aGUgZGVmaW5pdGlvbiBvZiB0aGUgSW1wZXJhdGl2ZUJhc2UgY2xhc3Mgd2l0aCB0aGlzIGZ1bmN0aW9uIGluXG4vLyBvcmRlciB0byBzb2x2ZSB0aGUgY2lyY3VsYXIgZGVwZGVuZGVuY3kgcHJvYmxlbSBjYXVzZWQgYnkgdGhlXG4vLyBOb2RlPC0+SW1wZXJhdGl2ZUJhc2UgYW5kIFNjZW5lPC0+SW1wZXJhdGl2ZUJhc2UgY2lyY2xlcy4gVGhlIE5vZGUgYW5kIFNjZW5lXG4vLyBtb2R1bGVzIGNhbGwgaW5pdEltcGVyYXRpdmVCYXNlIHRvIGVuc3VyZSB0aGF0IHRoZSBJbXBlcmF0aXZlQmFzZSBkZWNsYXJhdGlvblxuLy8gaGFwcGVucyBmaXJzdCwgYW5kIHRoZW4gdGhvc2UgbW9kdWxlcyBjYW4gdXNlIHRoZSBsaXZlIGJpbmRpbmcgaW4gdGhlaXJcbi8vIGRlY2xhcmF0aW9ucy5cbmluaXRJbXBlcmF0aXZlQmFzZSgpXG5leHBvcnQgZnVuY3Rpb24gaW5pdEltcGVyYXRpdmVCYXNlKCkge1xuICAgIGlmIChJbXBlcmF0aXZlQmFzZSkgcmV0dXJuXG5cbiAgICBjb25zdCBpbnN0YW5jZW9mU3ltYm9sID0gU3ltYm9sKCdpbnN0YW5jZW9mU3ltYm9sJylcblxuICAgIC8qKlxuICAgICAqIFRoZSBJbXBlcmF0aXZlQmFzZSBjbGFzcyBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgdGhlIEltcGVyYXRpdmUgdmVyc2lvbiBvZiB0aGVcbiAgICAgKiBBUEksIGZvciBwZW9wbGUgd2hvIGNob3NlIHRvIHRha2UgdGhlIGFsbC1KYXZhU2NyaXB0IGFwcHJvYWNoIGFuZCB3aG8gd2lsbFxuICAgICAqIG5vdCB1c2UgdGhlIEhUTUwtYmFzZWQgQVBJIChpbmZhbW91cy9tb3Rvci1odG1sKS5cbiAgICAgKlxuICAgICAqIEluIHRoZSBmdXR1cmUgd2hlbiB0aGVyZSBpcyBhbiBvcHRpb24gdG8gZGlzYWJsZSB0aGUgSFRNTC1ET00gcmVuZGVyaW5nIChhbmRcbiAgICAgKiByZW5kZXIgb25seSBXZWJHTCwgZm9yIGV4YW1wbGUpIHRoZW4gdGhlIGltcGVyYXRpdmUgQVBJIHdpbGwgYmUgdGhlIG9ubHkgQVBJXG4gICAgICogYXZhaWxhYmxlIHNpbmNlIHRoZSBIVE1MIEFQSSB3aWxsIGJlIHR1cm5lZCBvZmYgYXMgYSByZXN1bHQgb2YgZGlzYWJsaW5nXG4gICAgICogSFRNTCByZW5kZXJpbmcuIERpc2FibGluZyBib3RoIFdlYkdMIGFuZCBIVE1MIHdvbid0IG1ha2Ugc2Vuc2UsIGFzIHdlJ2xsIG5lZWRcbiAgICAgKiBhdCBsZWFzdCBvbmUgb2YgdGhvc2UgdG8gcmVuZGVyIHdpdGguXG4gICAgICovXG4gICAgY29uc3QgSW1wZXJhdGl2ZUJhc2VNaXhpbiA9IGJhc2UgPT4ge1xuICAgICAgICBjb25zdCBQYXJlbnRDbGFzcyA9IGJhc2VcbiAgICAgICAgY2xhc3MgSW1wZXJhdGl2ZUJhc2UgZXh0ZW5kcyBQYXJlbnRDbGFzcyB7XG4gICAgICAgICAgICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcblxuICAgICAgICAgICAgICAgIC8vIFRoZSBwcmVzZW5jZSBvZiBhIF9tb3Rvckh0bWxDb3VudGVycGFydCBhcmd1bWVudCBzaWduaWZpZXMgdGhhdFxuICAgICAgICAgICAgICAgIC8vIHRoZSBIVE1MIGludGVyZmFjZSBpcyBiZWluZyB1c2VkLCBvdGhlcndpc2UgdGhlIGltcGVyYXRpdmUgaW50ZXJmYWNlXG4gICAgICAgICAgICAgICAgLy8gaGVyZSBpcyBiZWluZyB1c2VkLiBGb3IgZXhhbXBsZSwgc2VlIE1vdG9ySFRNTE5vZGUuIFRoaXMgbWVhbnMgdGhlXG4gICAgICAgICAgICAgICAgLy8gTm9kZSBhbmQgTW90b3JIVE1MTm9kZSBjbGFzc2VzIGFyZSBjb3VwbGVkIHRvZ2V0aGVyLCBidXQgaXQncyBpbiB0aGVcbiAgICAgICAgICAgICAgICAvLyBuYW1lIG9mIHRoZSBBUEkgdGhhdCB3ZSdyZSBzdXBwb3J0aW5nLlxuICAgICAgICAgICAgICAgIGNvbnN0IHtfbW90b3JIdG1sQ291bnRlcnBhcnR9ID0gb3B0aW9uc1xuXG4gICAgICAgICAgICAgICAgc3VwZXIob3B0aW9ucylcblxuICAgICAgICAgICAgICAgIHRoaXMuX3dpbGxCZVJlbmRlcmVkID0gZmFsc2VcblxuICAgICAgICAgICAgICAgIC8vIEhlcmUgd2UgY3JlYXRlIHRoZSBET00gSFRNTEVsZW1lbnQgYXNzb2NpYXRlZCB3aXRoIHRoaXNcbiAgICAgICAgICAgICAgICAvLyBJbXBlcmF0aXZlLUFQSSBOb2RlLlxuICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRNYW5hZ2VyID0gbmV3IEVsZW1lbnRNYW5hZ2VyKFxuICAgICAgICAgICAgICAgICAgICBfbW90b3JIdG1sQ291bnRlcnBhcnQgfHwgdGhpcy5fbWFrZUVsZW1lbnQoKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50TWFuYWdlci5lbGVtZW50Ll9hc3NvY2lhdGVJbXBlcmF0aXZlTm9kZSh0aGlzKVxuXG4gICAgICAgICAgICAgICAgLy8gRm9yIE5vZGVzLCB0cnVlIHdoZW4gdGhpcyBOb2RlIGlzIGFkZGVkIHRvIGEgcGFyZW50IEFORCBpdFxuICAgICAgICAgICAgICAgIC8vIGhhcyBhbiBhbmFuY2VzdG9yIFNjZW5lIHRoYXQgaXMgbW91bnRlZCBpbnRvIERPTS4gRm9yXG4gICAgICAgICAgICAgICAgLy8gU2NlbmVzLCB0cnVlIHdoZW4gbW91bnRlZCBpbnRvIERPTS5cbiAgICAgICAgICAgICAgICB0aGlzLl9tb3VudGVkID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICAvLyBGb3IgTm9kZXMsIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdoZW4gdGhpcyBOb2RlIGlzXG4gICAgICAgICAgICAgICAgLy8gYXR0YWNoZWQgdG8gYSB0cmVlIHRoYXQgaGFzIGEgcm9vdCBTY2VuZSBUcmVlTm9kZSAqYW5kKiB3aGVuXG4gICAgICAgICAgICAgICAgLy8gdGhhdCByb290IFNjZW5lIGhhcyBiZWVuIG1vdW50ZWQgaW50byB0aGUgRE9NLiBGb3IgU2NlbmVzLFxuICAgICAgICAgICAgICAgIC8vIHJlc29sdmVzIHdoZW4gbW91bnRlZCBpbnRvIERPTS5cbiAgICAgICAgICAgICAgICB0aGlzLl9tb3VudFByb21pc2UgPSBudWxsXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZU1vdW50UHJvbWlzZSA9IG51bGxcbiAgICAgICAgICAgICAgICB0aGlzLl9yZWplY3RNb3VudFByb21pc2UgPSBudWxsXG5cbiAgICAgICAgICAgICAgICB0aGlzLl9hd2FpdGluZ01vdW50UHJvbWlzZVRvUmVuZGVyID0gZmFsc2VcbiAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nRm9yTW91bnRDb25kaXRpb25zID0gZmFsc2VcblxuICAgICAgICAgICAgICAgIC8vIFNlZSBUcmFuc2Zvcm1hYmxlL1NpemVhYmxlIHByb3BlcnR5Y2hhbmdlIGV2ZW50LlxuICAgICAgICAgICAgICAgIHRoaXMub24oJ3Byb3BlcnR5Y2hhbmdlJywgcHJvcCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgPT0gJ3NpemVNb2RlJyB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcCA9PSAnYWJzb2x1dGVTaXplJyB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcCA9PSAncHJvcG9ydGlvbmFsU2l6ZSdcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jYWxjU2l6ZSgpXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZWVkc1RvQmVSZW5kZXJlZCgpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBTdWJjbGFzc2VzIGFyZSByZXF1aXJlZCB0byBvdmVycmlkZSB0aGlzLiBJdCBzaG91bGQgcmV0dXJuIHRoZSBIVE1MLUFQSVxuICAgICAgICAgICAgICogY291bnRlcnBhcnQgZm9yIHRoaXMgSW1wZXJhdGl2ZS1BUEkgaW5zdGFuY2UuIFNlZSBOb2RlIG9yIFNjZW5lIGNsYXNzZXNcbiAgICAgICAgICAgICAqIGZvciBleGFtcGxlLlxuICAgICAgICAgICAgICpcbiAgICAgICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIF9tYWtlRWxlbWVudCgpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N1YmNsYXNzZXMgbmVlZCB0byBvdmVycmlkZSBJbXBlcmF0aXZlQmFzZSNfbWFrZUVsZW1lbnQuJylcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAcmVhZG9ubHlcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZ2V0IG1vdW50UHJvbWlzZSgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX21vdW50UHJvbWlzZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9tb3VudFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlTW91bnRQcm9taXNlID0gcmVzb2x2ZVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVqZWN0TW91bnRQcm9taXNlID0gcmVqZWN0XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9tb3VudGVkKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0Rm9yTW91bnRUaGVuUmVzb2x2ZU1vdW50UHJvbWlzZSgpXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5fbW91bnRlZClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZU1vdW50UHJvbWlzZSgpXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbW91bnRQcm9taXNlXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIF93YWl0Rm9yTW91bnRUaGVuUmVzb2x2ZU1vdW50UHJvbWlzZSgpIHtcbiAgICAgICAgICAgICAgICAvLyBleHRlbmRlZCBpbiBOb2RlIG9yIFNjZW5lIHRvIGF3YWl0IGZvciBhbnl0aGluZyB0aGF0IG1vdW50XG4gICAgICAgICAgICAgICAgLy8gZGVwZW5kcyBvbi5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAcmVhZG9ubHlcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZ2V0IGVsZW1lbnQoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRNYW5hZ2VyLmVsZW1lbnRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAb3ZlcnJpZGVcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgYWRkQ2hpbGQoY2hpbGROb2RlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0luc3RhbmNlb2YoY2hpbGROb2RlLCBJbXBlcmF0aXZlQmFzZSkpIHJldHVyblxuXG4gICAgICAgICAgICAgICAgLy8gV2UgY2Fubm90IGFkZCBTY2VuZXMgdG8gTm9kZXMsIGZvciBub3cuXG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZSBpbnN0YW5jZW9mIFNjZW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgXG4gICAgICAgICAgICAgICAgICAgICAgICBBIFNjZW5lIGNhbm5vdCBiZSBhZGRlZCB0byBhbm90aGVyIE5vZGUgb3IgU2NlbmUgKGF0XG4gICAgICAgICAgICAgICAgICAgICAgICBsZWFzdCBmb3Igbm93KS4gVG8gcGxhY2UgYSBTY2VuZSBpbiBhIE5vZGUsIGp1c3QgbW91bnRcbiAgICAgICAgICAgICAgICAgICAgICAgIGEgbmV3IFNjZW5lIG9udG8gYSBNb3RvckhUTUxOb2RlIHdpdGggU2NlbmUubW91bnQoKS5cbiAgICAgICAgICAgICAgICAgICAgYClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzdXBlci5hZGRDaGlsZChjaGlsZE5vZGUpXG5cbiAgICAgICAgICAgICAgICAvLyBQYXNzIHRoaXMgcGFyZW50IG5vZGUncyBTY2VuZSByZWZlcmVuY2UgKGlmIGFueSwgY2hlY2tpbmcgdGhpcyBjYWNoZVxuICAgICAgICAgICAgICAgIC8vIGZpcnN0KSB0byB0aGUgbmV3IGNoaWxkIGFuZCB0aGUgY2hpbGQncyBjaGlsZHJlbi5cbiAgICAgICAgICAgICAgICBpZiAoY2hpbGROb2RlLl9zY2VuZSB8fCBjaGlsZE5vZGUuc2NlbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZS5fcmVzb2x2ZVNjZW5lUHJvbWlzZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5fcmVzb2x2ZVNjZW5lUHJvbWlzZShjaGlsZE5vZGUuX3NjZW5lKVxuICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuX2dpdmVTY2VuZVJlZlRvQ2hpbGRyZW4oKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBzaXppbmcgYmVjYXVzZSBwcm9wb3J0aW9uYWwgc2l6ZSBtaWdodCBkZXBlbmQgb25cbiAgICAgICAgICAgICAgICAvLyB0aGUgbmV3IHBhcmVudC5cbiAgICAgICAgICAgICAgICBjaGlsZE5vZGUuX2NhbGNTaXplKClcbiAgICAgICAgICAgICAgICBjaGlsZE5vZGUuX25lZWRzVG9CZVJlbmRlcmVkKClcblxuICAgICAgICAgICAgICAgIC8vIGNoaWxkIHNob3VsZCB3YXRjaCB0aGUgcGFyZW50IGZvciBzaXplIGNoYW5nZXMuXG4gICAgICAgICAgICAgICAgdGhpcy5vbignc2l6ZWNoYW5nZScsIGNoaWxkTm9kZS5fb25QYXJlbnRTaXplQ2hhbmdlKVxuXG4gICAgICAgICAgICAgICAgdGhpcy5fZWxlbWVudE1hbmFnZXIuY29ubmVjdENoaWxkRWxlbWVudChjaGlsZE5vZGUpXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZW1vdmVDaGlsZChjaGlsZE5vZGUsIC8qcHJpdmF0ZSB1c2UqL2xlYXZlSW5Eb20pIHtcbiAgICAgICAgICAgICAgICBpZiAoIShjaGlsZE5vZGUgaW5zdGFuY2VvZiBOb2RlKSkgcmV0dXJuXG5cbiAgICAgICAgICAgICAgICBzdXBlci5yZW1vdmVDaGlsZChjaGlsZE5vZGUpXG5cbiAgICAgICAgICAgICAgICB0aGlzLm9mZignc2l6ZWNoYW5nZScsIGNoaWxkTm9kZS5fb25QYXJlbnRTaXplQ2hhbmdlKVxuXG4gICAgICAgICAgICAgICAgY2hpbGROb2RlLl9yZXNldFNjZW5lUmVmKClcblxuICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGUuX21vdW50UHJvbWlzZSkgY2hpbGROb2RlLl9yZWplY3RNb3VudFByb21pc2UoJ21vdW50Y2FuY2VsJylcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGROb2RlLl9tb3VudGVkKSBjaGlsZE5vZGUuX2VsZW1lbnRNYW5hZ2VyLnNob3VsZE5vdFJlbmRlcigpXG4gICAgICAgICAgICAgICAgY2hpbGROb2RlLl9yZXNldE1vdW50UHJvbWlzZSgpXG5cbiAgICAgICAgICAgICAgICBpZiAoIWxlYXZlSW5Eb20pXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRNYW5hZ2VyLmRpc2Nvbm5lY3RDaGlsZEVsZW1lbnQoY2hpbGROb2RlKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBfcmVzZXRNb3VudFByb21pc2UoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbW91bnRlZCA9IGZhbHNlXG4gICAgICAgICAgICAgICAgdGhpcy5fbW91bnRQcm9taXNlID0gbnVsbFxuICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVNb3VudFByb21pc2UgPSBudWxsXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVqZWN0TW91bnRQcm9taXNlID0gbnVsbFxuICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5fY2hpbGRyZW5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpPTAsIGw9Y2hpbGRyZW4ubGVuZ3RoOyBpPGw7IGkrPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5baV0uX3Jlc2V0TW91bnRQcm9taXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBfbmVlZHNUb0JlUmVuZGVyZWQoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2F3YWl0aW5nTW91bnRQcm9taXNlVG9SZW5kZXIpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuXG4gICAgICAgICAgICAgICAgY29uc3QgbG9naWMgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3dpbGxCZVJlbmRlcmVkID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICBNb3Rvci5fc2V0Tm9kZVRvQmVSZW5kZXJlZCh0aGlzKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5fbW91bnRlZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hd2FpdGluZ01vdW50UHJvbWlzZVRvUmVuZGVyID0gdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBwb3NzaWJsZUVycm9yID0gdW5kZWZpbmVkXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gdHJ5XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1vdW50UHJvbWlzZVxuXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGxvZ2ljKVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGNhdGNoXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSA9PSAnbW91bnRjYW5jZWwnKSByZXR1cm5cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcG9zc2libGVFcnJvciA9IGVcbiAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgICAvLyBmaW5hbGx5XG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2F3YWl0aW5nTW91bnRQcm9taXNlVG9SZW5kZXIgPSBmYWxzZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zc2libGVFcnJvcikgdGhyb3cgcG9zc2libGVFcnJvclxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxvZ2ljKClcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vYXN5bmMgX25lZWRzVG9CZVJlbmRlcmVkKCkge1xuICAgICAgICAgICAgICAgIC8vaWYgKHRoaXMuX2F3YWl0aW5nTW91bnRQcm9taXNlVG9SZW5kZXIpIHJldHVyblxuXG4gICAgICAgICAgICAgICAgLy9pZiAoIXRoaXMuX21vdW50ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgLy90cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy90aGlzLl9hd2FpdGluZ01vdW50UHJvbWlzZVRvUmVuZGVyID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgLy9hd2FpdCB0aGlzLm1vdW50UHJvbWlzZVxuICAgICAgICAgICAgICAgICAgICAvL30gY2F0Y2goZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiAoZSA9PSAnbW91bnRjYW5jZWwnKSByZXR1cm5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vZWxzZSB0aHJvdyBlXG4gICAgICAgICAgICAgICAgICAgIC8vfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fYXdhaXRpbmdNb3VudFByb21pc2VUb1JlbmRlciA9IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIC8vfVxuICAgICAgICAgICAgICAgIC8vfVxuXG4gICAgICAgICAgICAgICAgLy90aGlzLl93aWxsQmVSZW5kZXJlZCA9IHRydWVcbiAgICAgICAgICAgICAgICAvL01vdG9yLl9zZXROb2RlVG9CZVJlbmRlcmVkKHRoaXMpXG4gICAgICAgICAgICAvL31cblxuICAgICAgICAgICAgLy8gVGhpcyBtZXRob2QgaXMgdXNlZCBieSBNb3Rvci5fcmVuZGVyTm9kZXMoKS5cbiAgICAgICAgICAgIF9nZXRBbmNlc3RvclRvQmVSZW5kZXJlZCgpIHtcbiAgICAgICAgICAgICAgICBsZXQgcGFyZW50ID0gdGhpcy5fcGFyZW50XG5cbiAgICAgICAgICAgICAgICB3aGlsZSAocGFyZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuX3dpbGxCZVJlbmRlcmVkKSByZXR1cm4gcGFyZW50XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5fcGFyZW50XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIF9yZW5kZXIodGltZXN0YW1wKSB7XG4gICAgICAgICAgICAgICAgc3VwZXIuX3JlbmRlcigpXG4gICAgICAgICAgICAgICAgLy8gYXBwbGllcyB0aGUgdHJhbnNmb3JtIG1hdHJpeCB0byB0aGUgZWxlbWVudCdzIHN0eWxlIHByb3BlcnR5LlxuICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRNYW5hZ2VyLmFwcGx5SW1wZXJhdGl2ZU5vZGVQcm9wZXJ0aWVzKHRoaXMpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7c2V0OiBzdXBlclByb3BlcnRpZXNTZXR9ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihQYXJlbnRDbGFzcy5wcm90b3R5cGUsICdwcm9wZXJ0aWVzJylcblxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhJbXBlcmF0aXZlQmFzZS5wcm90b3R5cGUsIHtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBTZXQgYWxsIHByb3BlcnRpZXMgb2YgYW4gSW1wZXJhdGl2ZUJhc2UgaW5zdGFuY2UgaW4gb25lIG1ldGhvZC5cbiAgICAgICAgICAgICAqXG4gICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBQcm9wZXJ0aWVzIG9iamVjdCAtIHNlZSBleGFtcGxlLlxuICAgICAgICAgICAgICpcbiAgICAgICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAgICAgKiBub2RlLnByb3BlcnRpZXMgPSB7XG4gICAgICAgICAgICAgKiAgIGNsYXNzZXM6IFsnb3BlbicsICdiaWcnXSxcbiAgICAgICAgICAgICAqIH1cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgIHNldChwcm9wZXJ0aWVzID0ge30pIHtcbiAgICAgICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzU2V0LmNhbGwodGhpcywgcHJvcGVydGllcylcblxuICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcy5jbGFzc2VzKVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZWxlbWVudE1hbmFnZXIuc2V0Q2xhc3NlcyguLi5wcm9wZXJ0aWVzLmNsYXNzZXMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSlcblxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSW1wZXJhdGl2ZUJhc2UsIFN5bWJvbC5oYXNJbnN0YW5jZSwge1xuICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKG9iaikge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzICE9PSBJbXBlcmF0aXZlQmFzZSkgcmV0dXJuIE9iamVjdC5nZXRQcm90b3R5cGVPZihJbXBlcmF0aXZlQmFzZSlbU3ltYm9sLmhhc0luc3RhbmNlXS5jYWxsKHRoaXMsIG9iailcblxuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UHJvdG8gPSBvYmpcblxuICAgICAgICAgICAgICAgIHdoaWxlKGN1cnJlbnRQcm90bykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjdXJyZW50UHJvdG8sIFwiY29uc3RydWN0b3JcIilcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZGVzYyAmJiBkZXNjLnZhbHVlICYmIGRlc2MudmFsdWUuaGFzT3duUHJvcGVydHkoaW5zdGFuY2VvZlN5bWJvbCkpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihjdXJyZW50UHJvdG8pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgSW1wZXJhdGl2ZUJhc2VbaW5zdGFuY2VvZlN5bWJvbF0gPSB0cnVlXG5cbiAgICAgICAgcmV0dXJuIEltcGVyYXRpdmVCYXNlXG4gICAgfVxuXG4gICAgSW1wZXJhdGl2ZUJhc2UgPSBJbXBlcmF0aXZlQmFzZU1peGluKFNpemVhYmxlKVxuICAgIEltcGVyYXRpdmVCYXNlLm1peGluID0gSW1wZXJhdGl2ZUJhc2VNaXhpblxuXG59XG5cbmV4cG9ydCB7SW1wZXJhdGl2ZUJhc2UgYXMgZGVmYXVsdH1cbiJdLCJuYW1lcyI6WyJzdXBlciIsInRoaXMiXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sY0FBYyxNQUFNLGtCQUFrQjtBQUM3QyxPQUFPLFFBQVEsTUFBTSxZQUFZO0FBQ2pDLE9BQU8sSUFBSSxNQUFNLFFBQVE7QUFDekIsT0FBTyxLQUFLLE1BQU0sU0FBUztBQUMzQixPQUFPLEtBQUssTUFB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