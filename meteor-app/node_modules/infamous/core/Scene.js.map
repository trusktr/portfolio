{"version":3,"file":"Scene.js","sources":["../../src/core/Scene.js"],"sourcesContent":["\n// although Transformable is not used in this file, importing it first prevents\n// a cyclical dependeny problem when an app entrypoint imports ./Scene.js\n// before ./Node.js (Sizeable imports Motor which imports Transformable which\n// imports Sizeable). See:\n// https://esdiscuss.org/topic/how-to-solve-this-basic-es6-module-circular-dependency-problem\n// TODO: write a test that imports public interfaces in every possible\n// permutation to detect circular dependency errors.\n//\n// Transformable is not used in this file, but importing here solves the\n// circular dependency problem.\nimport Transformable from './Transformable'\n// Sizeable is used in this file.\nimport Sizeable from './Sizeable'\n\nimport ImperativeBase, {initImperativeBase} from './ImperativeBase'\nimport XYZValues from './XYZValues'\nimport HTMLScene from '../html/HTMLScene'\nimport documentReady from 'awaitbox/dom/documentReady'\n\ninitImperativeBase()\n\n// Scene is Sizeable, which is currently a subset of Transformable.\nconst ParentClass = ImperativeBase.mixin(Sizeable)\nclass Scene extends ParentClass {\n    constructor(options = {}) {\n        super(options)\n\n        // NOTE: z size is always 0, since native DOM elements are always flat.\n        this._elementParentSize = {x:0, y:0, z:0}\n\n        this._onElementParentSizeChange = (newSize) => {\n            this._elementParentSize = newSize\n            this._calcSize()\n            this._needsToBeRendered()\n        }\n\n        this._calcSize()\n        this._needsToBeRendered()\n    }\n\n    _setDefaultProperties() {\n        super._setDefaultProperties()\n\n        Object.assign(this._properties, {\n            sizeMode: new XYZValues('proportional', 'proportional', 'absolute'),\n        })\n    }\n\n    _startOrStopSizePolling() {\n        if (\n            this._mounted &&\n            (this._properties.sizeMode.x == 'proportional'\n            || this._properties.sizeMode.y == 'proportional'\n            || this._properties.sizeMode.z == 'proportional')\n        ) {\n            this._startSizePolling()\n        }\n        else {\n            this._stopSizePolling()\n        }\n    }\n\n    // observe size changes on the scene element.\n    _startSizePolling() {\n        if (!this._elementManager) return\n        this._elementManager.element._startSizePolling()\n        this._elementManager.element.on('parentsizechange', this._onElementParentSizeChange)\n    }\n\n    // Don't observe size changes on the scene element.\n    _stopSizePolling() {\n        if (!this._elementManager) return\n        this._elementManager.element.off('parentsizechange', this._onElementParentSizeChange)\n        this._elementManager.element._stopSizePolling()\n    }\n\n    /** @override */\n    _getParentSize() {\n        return this._mounted ? this._elementParentSize : {x:0,y:0,z:0}\n    }\n\n    /**\n     * @override\n     */\n    _makeElement() {\n        return new HTMLScene\n    }\n\n    /**\n     * Mount the scene into the given target.\n     * Resolves the Scene's mountPromise, which can be use to do something once\n     * the scene is mounted.\n     *\n     * @param {string|HTMLElement} [mountPoint=document.body] If a string selector is provided,\n     * the mount point will be selected from the DOM. If an HTMLElement is\n     * provided, that will be the mount point. If no mount point is provided,\n     * the scene will be mounted into document.body.\n     */\n    mount(mountPoint) {\n        const mountLogic = () => {\n            // if no mountPoint was provided, just mount onto the <body> element.\n            if (mountPoint === undefined) mountPoint = document.body\n\n            // if the user supplied a selector, mount there.\n            else if (typeof mountPoint === 'string')\n                mountPoint = document.querySelector(mountPoint)\n\n            // if we have an actual mount point (the user may have supplied one)\n            if (!(mountPoint instanceof window.HTMLElement))\n                throw new Error('Invalid mount point specified in Scene.mount() call. Pass a selector, an actual HTMLElement, or don\\'t pass anything to mount to <body>.')\n\n            if (this._mounted) this.unmount()\n\n            if (mountPoint !== this._elementManager.element.parentNode)\n                mountPoint.appendChild(this._elementManager.element)\n\n            this._mounted = true\n\n            if (this._mountPromise) this._resolveMountPromise()\n\n            this._elementManager.shouldRender()\n            this._startOrStopSizePolling()\n        }\n\n        // Wait for the document to be ready before mounting, otherwise the\n        // target mount point might not exist yet when this function is called.\n        if (document.readyState == 'loading') return documentReady().then(mountLogic)\n        else {\n            mountLogic()\n            return Promise.resolve()\n        }\n    }\n    //async mount(mountPoint) {\n        //// Wait for the document to be ready before mounting, otherwise the\n        //// target mount point might not exist yet when this function is called.\n        //if (document.readyState == 'loading') await documentReady()\n\n        //// if no mountPoint was provided, just mount onto the <body> element.\n        //if (mountPoint === undefined) mountPoint = document.body\n\n        //// if the user supplied a selector, mount there.\n        //else if (typeof mountPoint === 'string')\n            //mountPoint = document.querySelector(mountPoint)\n\n        //// if we have an actual mount point (the user may have supplied one)\n        //if (!(mountPoint instanceof window.HTMLElement))\n            //throw new Error('Invalid mount point specified in Scene.mount() call. Pass a selector, an actual HTMLElement, or don\\'t pass anything to mount to <body>.')\n\n        //if (this._mounted) this.unmount()\n\n        //if (mountPoint !== this._elementManager.element.parentNode)\n            //mountPoint.appendChild(this._elementManager.element)\n\n        //this._mounted = true\n\n        //if (this._mountPromise) this._resolveMountPromise()\n\n        //this._elementManager.shouldRender()\n        //this._startOrStopSizePolling()\n    //}\n\n    /**\n     * Unmount the scene from it's mount point. Resets the Scene's\n     * mountPromise.\n     */\n    unmount() {\n        if (!this._mounted) return\n\n        this._elementManager.shouldNotRender()\n        this._stopSizePolling()\n\n        if (this._elementManager.element.parentNode)\n            this._elementManager.element.parentNode.removeChild(this._elementManager.element)\n\n        if (this._mountPromise) this._rejectMountPromise('mountcancel')\n        this._resetMountPromise()\n    }\n\n}\n\n// Here we know that `super` is Sizeable\nconst {set: superSizeModeSet, get: superSizeModeGet} = Object.getOwnPropertyDescriptor(Sizeable.prototype, 'sizeMode')\n\nObject.defineProperties(Scene.prototype, {\n\n    // When we set the scene's size mode, we should start polling if it has\n    // proportional sizing.\n    sizeMode: {\n        set: function(value) {\n            superSizeModeSet.call(this, value)\n            this._startOrStopSizePolling()\n        },\n        get: function() {\n            return superSizeModeGet.call(this)\n        },\n        configurable: true,\n        enumerable: true,\n    }\n\n})\n\nexport {Scene as default}\n"],"names":[],"mappings":"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"}